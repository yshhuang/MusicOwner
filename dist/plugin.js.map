{"mappings":";;;AAQA,qBAAqB;AAErB,wCAAwC;AACxC,MAAM,+BAA8B,eAAgB,KAAK,EAAE,IAAI,EAAE,IAAI;IACnE,IAAI,SAAS,SACX,OAAO;QACL,OAAO;QACP,MAAM,EAAE;IACV;AAEJ;AAaA,IAAI,mCAA0B,CAAC;AAE/B,SAAS;IACP,MAAM,OAAE,GAAG,YAAE,QAAQ,YAAE,QAAQ,cAAE,UAAU,EAAE,GAC3C,KAAK,wBAAwB,CAAC;IAChC,IAAI,CAAE,CAAA,OAAO,YAAY,QAAO,GAC9B,OAAO;IAGT,IACE,CACE,CAAA,iCAAW,QAAQ,OACnB,iCAAW,aAAa,YACxB,iCAAW,aAAa,YACxB,iCAAW,eAAe,UAAS,GAErC;QACA,iCAAW,MAAM;QACjB,iCAAW,WAAW;QACtB,iCAAW,WAAW;QACtB,iCAAW,aAAa;QACxB,iCAAW,iBAAiB,YAAY,QAAQ;QAChD,iCAAW,gBAAgB;IAC7B;IAEA,OAAO,CAAA,GAAA,0BAAW,EAAE,KAAK;QACvB,UAAU,CAAA,GAAA,sBAAO,EAAE;kBACnB;kBACA;IACF;AACF;AAEA,eAAe,kCAAY,KAAa;IACtC,MAAM,SAAS;IACf,IAAI,CAAC,iCAAW,eAAe;QAC7B,MAAM,iBAAiB,iCAAW,gBAAgB,SAC9C,iCAAW,iBACX;YAAC;SAAI;QACT,IAAI,SAAqB,EAAE;QAE3B,KAAK,IAAI,UAAU,eACjB,IAAI;YACF,MAAM,YAAY,AACf,CAAA,MAAM,OAAO,qBAAqB,OAAM,EACzC,OAAO,CAAC,KAAO,GAAG,SAAS,UAAU,GAAG,KAAK,WAAW;YAC1D,SAAS;mBAAI;mBAAW;aAAU;QACpC,EAAE,OAAM,CAAE;QAEZ,iCAAW,gBAAgB;IAC7B;IAEA,OAAO;QACL,OAAO;QACP,MAAM,AAAC,CAAA,iCAAW,iBAAiB,EAAE,AAAD,EACjC,OAAO,CAAC,KAAO,GAAG,SAAS,SAAS,QACpC,IAAI,CAAC,KAAQ,CAAA;gBACZ,OAAO,GAAG;gBACV,IAAI,GAAG;gBACP,QAAQ;gBACR,OAAO;YACT,CAAA;IACJ;AACF;AAEA,MAAM,uCAAwC;IAC5C,UAAU;IACV,SAAS;IACT,wBAAwB;IAExB,QAAQ;AAEV;AAGA,iCAAiC;AAEjC,iBAAiB;IACf,UAAU;IACV,SAAS;IACT,QAAQ;IACR,eAAe;QACb;YACE,KAAK;YACL,MAAM;QACR;QACA;YACE,KAAK;YACL,MAAM;QACR;QACA;YACE,KAAK;YACL,MAAM;YACN,MAAM;QACR;QACA;YACE,KAAK;YACL,MAAM;QACR;KACD;YACD;AACF","sources":["src/index.ts"],"sourcesContent":["import axios from 'axios';\r\nimport cheerio from 'cheerio';\r\nimport cryptojs from 'crypto-js';\r\nimport dayjs from 'dayjs';\r\nimport bigInt from 'big-integer';\r\nimport he from 'he';\r\nimport qs from 'qs';\r\n\r\n// TODO: 你可以在这里写插件的逻辑\r\n\r\n// 注意：不要使用async () => {}，hermes不支持异步箭头函数\r\nconst search: IPlugin.ISearchFunc = async function (query, page, type) {\r\n  if (type === 'music') {\r\n    return {\r\n      isEnd: true,\r\n      data: []\r\n    }\r\n  };\r\n}\r\n\r\nimport { AuthType, FileStat, createClient } from \"webdav\";\r\n\r\ninterface ICachedData {\r\n  url?: string;\r\n  username?: string;\r\n  password?: string;\r\n  searchPath?: string;\r\n  searchPathList?: string[];\r\n  cacheFileList?: FileStat[];\r\n}\r\n\r\nlet cachedData: ICachedData = {};\r\n\r\nfunction getClient() {\r\n  const { url, username, password, searchPath } =\r\n    env?.getUserVariables?.() ?? {};\r\n  if (!(url && username && password)) {\r\n    return null;\r\n  }\r\n\r\n  if (\r\n    !(\r\n      cachedData.url === url &&\r\n      cachedData.username === username &&\r\n      cachedData.password === password &&\r\n      cachedData.searchPath === searchPath\r\n    )\r\n  ) {\r\n    cachedData.url = url;\r\n    cachedData.username = username;\r\n    cachedData.password = password;\r\n    cachedData.searchPath = searchPath;\r\n    cachedData.searchPathList = searchPath?.split?.(\",\");\r\n    cachedData.cacheFileList = null;\r\n  }\r\n\r\n  return createClient(url, {\r\n    authType: AuthType.Password,\r\n    username,\r\n    password,\r\n  });\r\n}\r\n\r\nasync function searchMusic(query: string) {\r\n  const client = getClient();\r\n  if (!cachedData.cacheFileList) {\r\n    const searchPathList = cachedData.searchPathList?.length\r\n      ? cachedData.searchPathList\r\n      : [\"/\"];\r\n    let result: FileStat[] = [];\r\n\r\n    for (let search of searchPathList) {\r\n      try {\r\n        const fileItems = (\r\n          (await client.getDirectoryContents(search)) as FileStat[]\r\n        ).filter((it) => it.type === \"file\" && it.mime.startsWith(\"audio\"));\r\n        result = [...result, ...fileItems];\r\n      } catch { }\r\n    }\r\n    cachedData.cacheFileList = result;\r\n  }\r\n\r\n  return {\r\n    isEnd: true,\r\n    data: (cachedData.cacheFileList ?? [])\r\n      .filter((it) => it.basename.includes(query))\r\n      .map((it) => ({\r\n        title: it.basename,\r\n        id: it.filename,\r\n        artist: \"未知作者\",\r\n        album: \"未知专辑\",\r\n      })),\r\n  };\r\n}\r\n\r\nconst pluginInstance: IPlugin.IPluginDefine = {\r\n  platform: \"MusicOwner\",\r\n  version: \"1.0.0\",\r\n  // TODO: 在这里把插件剩余的功能补充完整\r\n\r\n  search: search,\r\n\r\n};\r\n\r\n\r\n// export default pluginInstance;\r\n\r\nmodule.exports = {\r\n  platform: \"MusicOwner\",\r\n  version: \"1.0.0\",\r\n  srcUrl: \"https://gitee.com/yshhuang/MusicOwner/raw/master/dist/plugin.js\",\r\n  userVariables: [\r\n    {\r\n      key: \"url\",\r\n      name: \"WebDAV地址\",\r\n    },\r\n    {\r\n      key: \"username\",\r\n      name: \"用户名\",\r\n    },\r\n    {\r\n      key: \"password\",\r\n      name: \"密码\",\r\n      type: \"password\",\r\n    },\r\n    {\r\n      key: \"searchPath\",\r\n      name: \"存放歌曲的路径\",\r\n    },\r\n  ],\r\n  search\r\n}"],"names":[],"version":3,"file":"plugin.js.map"}