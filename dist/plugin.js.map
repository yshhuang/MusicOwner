{"mappings":";;;AAUA,IAAI,mCAA0B,CAAC;AAE/B,SAAS;IACP,MAAM,OAAE,GAAG,YAAE,QAAQ,YAAE,QAAQ,cAAE,UAAU,EAAE,GAC3C,KAAK,wBAAwB,CAAC;IAChC,IAAI,CAAE,CAAA,OAAO,YAAY,QAAO,GAC9B,OAAO;IAGT,IACE,CACE,CAAA,iCAAW,QAAQ,OACnB,iCAAW,aAAa,YACxB,iCAAW,aAAa,YACxB,iCAAW,eAAe,UAAS,GAErC;QACA,iCAAW,MAAM;QACjB,iCAAW,WAAW;QACtB,iCAAW,WAAW;QACtB,iCAAW,aAAa;QACxB,iCAAW,iBAAiB,YAAY,QAAQ;QAChD,iCAAW,gBAAgB;IAC7B;IAEA,OAAO,CAAA,GAAA,0BAAW,EAAE,KAAK;QACvB,UAAU,CAAA,GAAA,sBAAO,EAAE;kBACnB;kBACA;IACF;AACF;AAEA,eAAe,kCAAY,KAAa;IACtC,MAAM,SAAS;IACf,IAAI,CAAC,iCAAW,eAAe;QAC7B,MAAM,iBAAiB,iCAAW,gBAAgB,SAC9C,iCAAW,iBACX;YAAC;SAAI;QACT,IAAI,SAAqB,EAAE;QAE3B,KAAK,IAAI,UAAU,eACjB,IAAI;YACF,MAAM,YAAY,AACf,CAAA,MAAM,OAAO,qBAAqB,OAAM,EACzC,OAAO,CAAC,KAAO,GAAG,SAAS,UAAU,GAAG,KAAK,WAAW;YAC1D,SAAS;mBAAI;mBAAW;aAAU;QACpC,EAAE,OAAM,CAAC;QAEX,iCAAW,gBAAgB;IAC7B;IAEA,OAAO;QACL,OAAO;QACP,MAAM,AAAC,CAAA,iCAAW,iBAAiB,EAAE,AAAD,EACjC,OAAO,CAAC,KAAO,GAAG,SAAS,SAAS,QACpC,IAAI,CAAC,KAAQ,CAAA;gBACZ,OAAO,GAAG;gBACV,IAAI,GAAG;gBACP,QAAQ;gBACR,OAAO;YACT,CAAA;IACJ;AACF;AAEA,eAAe;IACb;IACA,MAAM,OAAO;QACX,OAAO;QACP,MAAM,AAAC,CAAA,iCAAW,kBAAkB,EAAE,AAAD,EAAG,IAAI,CAAC,KAAQ,CAAA;gBACnD,OAAO;gBACP,IAAI;YACN,CAAA;IACF;IACA,OAAO;QAAC;KAAK;AACf;AAEA,eAAe,uCAAiB,WAAwC;IACtE,MAAM,SAAS;IACf,MAAM,YAAY,AACf,CAAA,MAAM,OAAO,qBAAqB,YAAY,GAAE,EACjD,OAAO,CAAC,KAAO,GAAG,SAAS,UAAU,GAAG,KAAK,WAAW;IAE1D,OAAO;QACL,WAAW,UAAU,IAAI,CAAC,KAAQ,CAAA;gBAChC,OAAO,GAAG;gBACV,IAAI,GAAG;gBACP,QAAQ;gBACR,OAAO;YACT,CAAA;IACF;AACF;AAEA,iBAAiB;IACf,UAAU;IACV,QAAQ;IACR,aAAa;IACb,eAAe;QACb;YACE,KAAK;YACL,MAAM;QACR;QACA;YACE,KAAK;YACL,MAAM;QACR;QACA;YACE,KAAK;YACL,MAAM;YACN,MAAM;QACR;QACA;YACE,KAAK;YACL,MAAM;QACR;KACD;IACD,SAAS;IACT,qBAAqB;QAAC;KAAQ;IAC9B,QACE;IACF,cAAc;IACd,QAAO,KAAK,EAAE,IAAI,EAAE,IAAI;QACtB,IAAI,SAAS,SACX,OAAO,kCAAY;IAEvB;iBACA;sBACA;IACA,gBAAe,SAAS;QACtB,MAAM,SAAS;QACf,OAAO;YACL,KAAK,OAAO,oBAAoB,UAAU;QAC5C;IACF;AACF","sources":["src/index.ts"],"sourcesContent":["import { AuthType, FileStat, createClient } from \"webdav\";\r\n\r\ninterface ICachedData {\r\n  url?: string;\r\n  username?: string;\r\n  password?: string;\r\n  searchPath?: string;\r\n  searchPathList?: string[];\r\n  cacheFileList?: FileStat[];\r\n}\r\nlet cachedData: ICachedData = {};\r\n\r\nfunction getClient() {\r\n  const { url, username, password, searchPath } =\r\n    env?.getUserVariables?.() ?? {};\r\n  if (!(url && username && password)) {\r\n    return null;\r\n  }\r\n\r\n  if (\r\n    !(\r\n      cachedData.url === url &&\r\n      cachedData.username === username &&\r\n      cachedData.password === password &&\r\n      cachedData.searchPath === searchPath\r\n    )\r\n  ) {\r\n    cachedData.url = url;\r\n    cachedData.username = username;\r\n    cachedData.password = password;\r\n    cachedData.searchPath = searchPath;\r\n    cachedData.searchPathList = searchPath?.split?.(\",\");\r\n    cachedData.cacheFileList = null;\r\n  }\r\n\r\n  return createClient(url, {\r\n    authType: AuthType.Password,\r\n    username,\r\n    password,\r\n  });\r\n}\r\n\r\nasync function searchMusic(query: string) {\r\n  const client = getClient();\r\n  if (!cachedData.cacheFileList) {\r\n    const searchPathList = cachedData.searchPathList?.length\r\n      ? cachedData.searchPathList\r\n      : [\"/\"];\r\n    let result: FileStat[] = [];\r\n\r\n    for (let search of searchPathList) {\r\n      try {\r\n        const fileItems = (\r\n          (await client.getDirectoryContents(search)) as FileStat[]\r\n        ).filter((it) => it.type === \"file\" && it.mime.startsWith(\"audio\"));\r\n        result = [...result, ...fileItems];\r\n      } catch {}\r\n    }\r\n    cachedData.cacheFileList = result;\r\n  }\r\n\r\n  return {\r\n    isEnd: true,\r\n    data: (cachedData.cacheFileList ?? [])\r\n      .filter((it) => it.basename.includes(query))\r\n      .map((it) => ({\r\n        title: it.basename,\r\n        id: it.filename,\r\n        artist: \"未知作者\",\r\n        album: \"未知专辑\",\r\n      })),\r\n  };\r\n}\r\n\r\nasync function getTopLists() {\r\n  getClient();\r\n  const data = {\r\n    title: \"全部歌曲\",\r\n    data: (cachedData.searchPathList || []).map((it) => ({\r\n      title: it,\r\n      id: it,\r\n    })),\r\n  };\r\n  return [data];\r\n}\r\n\r\nasync function getTopListDetail(topListItem: IMusicSheet.IMusicSheetItem) {\r\n  const client = getClient();\r\n  const fileItems = (\r\n    (await client.getDirectoryContents(topListItem.id)) as FileStat[]\r\n  ).filter((it) => it.type === \"file\" && it.mime.startsWith(\"audio\"));\r\n\r\n  return {\r\n    musicList: fileItems.map((it) => ({\r\n      title: it.basename,\r\n      id: it.filename,\r\n      artist: \"未知作者\",\r\n      album: \"未知专辑\",\r\n    })),\r\n  };\r\n}\r\n\r\nmodule.exports = {\r\n  platform: \"MusicOwner\",\r\n  author: \"猫头猫\",\r\n  description: \"使用此插件前先配置用户变量\",\r\n  userVariables: [\r\n    {\r\n      key: \"url\",\r\n      name: \"WebDAV地址\",\r\n    },\r\n    {\r\n      key: \"username\",\r\n      name: \"用户名\",\r\n    },\r\n    {\r\n      key: \"password\",\r\n      name: \"密码\",\r\n      type: \"password\",\r\n    },\r\n    {\r\n      key: \"searchPath\",\r\n      name: \"存放歌曲的路径\",\r\n    },\r\n  ],\r\n  version: \"0.0.3\",\r\n  supportedSearchType: [\"music\"],\r\n  srcUrl:\r\n    \"https://gitee.com/yshhuang/MusicOwner/raw/master/dist/plugin.js\",\r\n  cacheControl: \"no-cache\",\r\n  search(query, page, type) {\r\n    if (type === \"music\") {\r\n      return searchMusic(query);\r\n    }\r\n  },\r\n  getTopLists,\r\n  getTopListDetail,\r\n  getMediaSource(musicItem) {\r\n    const client = getClient();\r\n    return {\r\n      url: client.getFileDownloadLink(musicItem.id),\r\n    };\r\n  },\r\n};\r\n"],"names":[],"version":3,"file":"plugin.js.map"}